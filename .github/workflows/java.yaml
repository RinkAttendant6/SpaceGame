# This is a basic workflow to help you get started with Actions

name: Java CI

on:
  push:
    branches:
      - main
    tags:
      - v[0-9]+.[0-9]+
      - v[0-9]+.[0-9]+.[0-9]+
  pull_request:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Java JDK
        uses: actions/setup-java@v1.4.3
        with:
          java-version: 8
          java-package: jdk+fx

      - name: Compile
        run: javac src/*.java -d build/classes

      - name: Create JAR
        run: '& "${env:JAVA_HOME}\bin\javapackager.exe" -createjar -appclass Menu -srcdir build/classes -outdir build -outfile SpaceGame -v'

      - name: Upload JAR
        uses: actions/upload-artifact@v2
        with:
          name: SpaceGame.jar
          path: build/SpaceGame.jar

  create-package-windows:
    needs: build
    runs-on: windows-latest
    steps:
      - name: Setup Java JDK
        uses: actions/setup-java@v1.4.3
        with:
          java-version: 8
          java-package: jdk+fx

      - name: Download JAR
        uses: actions/download-artifact@v2
        with:
          name: SpaceGame.jar

      - name: Create self-contained Windows package
        run: |
          New-Item -ItemType Directory build -Force
          & "${env:JAVA_HOME}\bin\javapackager.exe" -deploy -appclass Menu -name SpaceGame -native image -outdir build -outfile SpaceGame -title SpaceGame -srcdir . -srcfiles SpaceGame.jar -v
          Compress-Archive -Path build\bundles\SpaceGame\* -DestinationPath SpaceGame.zip -Force

      - name: Upload Windows package
        uses: actions/upload-artifact@v2
        with:
          name: SpaceGame_windows.zip
          path: SpaceGame.zip

  create-package-linux:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java JDK
        uses: actions/setup-java@v1.4.3
        with:
          java-version: 8
          java-package: jdk+fx

      - name: Download JAR
        uses: actions/download-artifact@v2
        with:
          name: SpaceGame.jar

      - name: Create self-contained Linux package
        run: |
          mkdir -p build
          $JAVA_HOME/bin/javapackager -deploy -appclass Menu -name SpaceGame -native image -outdir build -outfile SpaceGame -title SpaceGame -srcdir . -srcfiles SpaceGame.jar -v
          tar --directory build/bundles/SpaceGame --create --file SpaceGame.tar .
          gzip --best --keep SpaceGame.tar
          xz -9 --keep SpaceGame.tar

      - name: Upload Linux gzip package
        uses: actions/upload-artifact@v2
        with:
          name: SpaceGame_linux.tar.gz
          path: SpaceGame.tar.gz

      - name: Upload Linux xz package
        uses: actions/upload-artifact@v2
        with:
          name: SpaceGame_linux.tar.xz
          path: SpaceGame.tar.xz

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      - create-package-linux
      - create-package-windows
    steps:
      - uses: actions/download-artifact@v2
        id: download
      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: >-
            ${{steps.download.outputs.download-path}}/**/SpaceGame.jar,
            ${{steps.download.outputs.download-path}}/**/SpaceGame_linux.tar.gz,
            ${{steps.download.outputs.download-path}}/**/SpaceGame_linux.tar.xz,
            ${{steps.download.outputs.download-path}}/**/SpaceGame_windows.zip
          omitBody: true
          token: ${{ secrets.GITHUB_TOKEN }}